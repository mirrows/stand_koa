<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    body{
      min-height: 100vh;
      padding: 10px;
      margin: 0;
      box-sizing: border-box;
      background: 100% 100% / 200px 200px  no-repeat url('https://img.zcool.cn/community/01b5ec5bdb4003a80121ab5d810355.gif'),
      0% 0% / 360px 200px  no-repeat url('https://www.haoy99.com/FileUpload/2018-11/PNGTou_Ming_Bei_Jing-085016_115.png');
    }
    .link_ball{
      display: inline-block;
      width: 80px;
      line-height: 80px;
      background-color: #ddd;
      border-radius: 50%;
      margin: 20px;
      color: #fff;
      text-decoration: none;
      cursor: pointer;
    }
    .back_arrow{
      position: fixed;
      left: 20px;
      bottom: 20px;
      font-size: 32px;
      background: center / contain url('https://ts2.cn.mm.bing.net/th?id=OIP-C.1zMo-77F0KNEbklTzOledQHaEo&w=316&h=197');
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
      cursor: pointer;
    }
    .file_name_wrap{
      border-radius: 6px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    .file_name_text{
      display: inline-block;
      width: 88%;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #fff;
      mix-blend-mode: difference;
    }
    button{
      padding: 4px 20px;
      background-color: #6fc7e9;
      border: none;
      border-radius: 6px;
      box-shadow: 0 5px 5px #34b6e7;
      color: #fff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div style="width: 300px;padding: 10px;margin: 240px auto;text-align: center;">
    <div class="link_ball create_room" style="background: linear-gradient(#2193b0,#6dd5ed);">创建房间</div>
    <div class="content_wrap"></div>
  </div>
  <a class="back_arrow" href="/">
    back ➜
  </a>


  <script>
    // class Behavior {
    //   constructor () {
    //     this.init()
    //   }
    //   init() {
    //     this.domCreateRoom = document.querySelector('.create_room')
    //     this.domContentWrap = document.querySelector('.content_wrap')
    //     this.domFile = null
    //     this.domCreateRoom.onclick = this.show
    //     onbeforeunload = () => {
    //       console.log(this)
    //       this.SSE?.close()
    //       this.port && fetch('/send/clear', {
    //         method: 'POST',
    //         body: JSON.stringify({port: this.port})
    //       })
    //     }
    //   }
    //   show = () => {
    //     if (typeof EventSource === "undefined") {
    //       return alert('当前浏览器不支持大文件发送，请进行升级浏览器或使用其他浏览器打开')
    //     }
    //     console.log('show')
    //     fetch('/send/create', {
    //       method: 'POST'
    //     }).then(res => res.json()).then(({ data }) => {
    //       this.port = data.port
    //       this.domCreateRoom.innerText = data.port
    //       this.domFile = document.createElement('input')
    //       this.domFile.type = 'file'
    //       this.domCreateRoom.onclick = () => this.domFile.click()
    //       this.domFile.onchange = this.selectFile
    //       this.SSE = new SSEHandler(`/receive/file/${this.port}`, this.receiveFile)
    //     })
    //   }
    //   selectFile = (e) => {
    //     // console.log(e)
    //     this.domContentWrap.innerHTML = ''
    //     if (!this.domFile.files[0]) return
    //     this.SSE.SSE || (this.SSE = new SSEHandler(`/receive/file/${this.port}`, this.receiveFile))
    //     if (!this.domSendBtn) {
    //       this.domSendBtn = document.createElement('button')
    //       this.domSendBtn.innerText = '发送'
    //       this.domSendBtn.onclick = this.uploadFile
    //     } else {
    //       this.domSendBtn.removeAttribute('disabled')
    //     }
    //     if (!this.domFileName) {
    //       this.domFileName = document.createElement('div')
    //       this.domFileNameText = document.createElement('span')
    //       this.domFileName.classList.add('file_name_wrap')
    //       this.domFileNameText.classList.add('file_name_text')
    //     }
        
    //     this.domFileName.style.background = 'linear-gradient(90deg, #000 0, #fff 0%)'
    //     this.domFileNameText.innerText = this.domFile.files[0]?.name
    //     this.domFileName.appendChild(this.domFileNameText)
    //     this.domContentWrap.appendChild(this.domFileName)
    //     this.domContentWrap.appendChild(this.domSendBtn)
    //   }
    //   uploadFile = async () => {
    //     this.domSendBtn.setAttribute('disabled', true)
    //     const chunks = await sliceFile(this.domFile.files[0])
    //     this.tmpFiles || (this.tmpFiles = {})
    //     this.tmpFiles[chunks[0].id] = chunks
    //     console.log(chunks)
    //     for(let i = 0; i < chunks.length; i++) {
    //       const data = await fetch(`/send/uploadFile/${this.port}`, {
    //         method: 'POST',
    //         body: JSON.stringify(chunks[i])
    //       }).then(res => res.json())
    //       if(data.code) {
    //         return alert('传输错误，请重试')
    //       } else {
    //         this.tmpFiles[chunks[0].id][i].loaded = true
    //       }
    //     }
    //   }
    //   receiveFile = ({data}) => {
    //     const res = JSON.parse(data)
    //     const fileEvents = {
    //       start: this.startStoreFile,
    //       msg: this.storeFile,
    //       end: this.finishStoreFile
    //     }
    //     fileEvents[res.state]?.({sign: res.id, data: res})
    //   }
    //   files = {}
    //   startStoreFile = ({sign}) => {
    //     // 清理内存
    //     this.files = {}

    //     this.files[sign] = []
    //   }
    //   storeFile = ({sign, data}) => {
    //     this.files[sign].push(data)
    //     this.domFileName.style.background = `linear-gradient(90deg, #000 ${data.ind/data.total * 100}%, #fff ${data.ind/data.total * 100 + 10}%)`
    //     this.domFileNameText.innerText = `${(data.ind/data.total * 100).toFixed(2)}%\n` + data.name
    //   }
    //   finishStoreFile = ({sign, data}) => {
    //     this.files[sign].sort((a, b) => a.ind - b.ind)
    //     const url = this.files[sign].map(chunk => chunk.content).join('')
    //     const name = sign
    //     this.domSendBtn?.remove()
    //     if (!this.downLoadBtn) {
    //       this.downLoadBtn = document.createElement('button')
    //       this.downLoadBtn.innerText = '下载'
    //     }
    //     this.downLoadBtn.onclick = downloadFile.bind(this, {url, name})
    //     this.domContentWrap.appendChild(this.downLoadBtn)
    //     // downloadFile({url, name})
    //   }
      
    // }

    // new Behavior()


    const Behavior = {
      domCreateRoom: document.querySelector('.create_room'),
      domContentWrap: document.querySelector('.content_wrap'),
      domFile: null,
      init() {
        // this.domCreateRoom = document.querySelector('.create_room')
        // this.domContentWrap = document.querySelector('.content_wrap')
        // this.domFile = null
        this.domCreateRoom.onclick = this.show.bind(this)
        onbeforeunload = () => {
          this.SSE?.close()
          this.port && fetch('/send/clear', {
            method: 'POST',
            body: JSON.stringify({port: this.port})
          })
        }
      },
      show() {
        if (typeof EventSource === "undefined") {
          return alert('当前浏览器不支持大文件发送，请进行升级浏览器或使用其他浏览器打开')
        }
        console.log('show')
        fetch('/send/create', {
          method: 'POST'
        }).then(res => res.json()).then(({ data }) => {
          this.port = data.port
          this.domCreateRoom.innerText = data.port
          this.domFile = document.createElement('input')
          this.domFile.type = 'file'
          this.domCreateRoom.onclick = () => this.domFile.click()
          this.domFile.onchange = this.selectFile.bind(this)
          this.SSE = new SSEHandler(`/receive/file/${this.port}`, this.receiveFile.bind(this))
        })
      },
      selectFile(e) {
        // console.log(e)
        this.domContentWrap.innerHTML = ''
        if (!this.domFile.files[0]) return
        this.SSE.SSE || (this.SSE = new SSEHandler(`/receive/file/${this.port}`, this.receiveFile.bind(this)))
        if (!this.domSendBtn) {
          this.domSendBtn = document.createElement('button')
          this.domSendBtn.innerText = '发送'
          this.domSendBtn.onclick = this.uploadFile.bind(this)
        } else {
          this.domSendBtn.removeAttribute('disabled')
        }
        if (!this.domFileName) {
          this.domFileName = document.createElement('div')
          this.domFileNameText = document.createElement('span')
          this.domFileName.classList.add('file_name_wrap')
          this.domFileNameText.classList.add('file_name_text')
        }
        
        this.domFileName.style.background = 'linear-gradient(90deg, #000 0, #fff 0%)'
        this.domFileNameText.innerText = this.domFile.files[0]?.name
        this.domFileName.appendChild(this.domFileNameText)
        this.domContentWrap.appendChild(this.domFileName)
        this.domContentWrap.appendChild(this.domSendBtn)
      },
      async uploadFile() {
        this.domSendBtn.setAttribute('disabled', true)
        const chunks = await sliceFile(this.domFile.files[0])
        this.tmpFiles || (this.tmpFiles = {})
        this.tmpFiles[chunks[0].id] = chunks
        console.log(chunks)
        for(let i = 0; i < chunks.length; i++) {
          const data = await fetch(`/send/uploadFile/${this.port}`, {
            method: 'POST',
            body: JSON.stringify(chunks[i])
          }).then(res => res.json())
          if(data.code) {
            return alert('传输错误，请重试')
          } else {
            this.tmpFiles[chunks[0].id][i].loaded = true
          }
        }
      },
      receiveFile({data}) {
        const res = JSON.parse(data)
        const fileEvents = {
          start: this.startStoreFile.bind(this),
          msg: this.storeFile.bind(this),
          end: this.finishStoreFile.bind(this)
        }
        fileEvents[res.state]?.({sign: res.id, data: res})
      },
      files: {},
      startStoreFile({sign}) {
        // 清理内存
        this.files = {}

        this.files[sign] = []
      },
      storeFile({sign, data}) {
        this.files[sign].push(data)
        this.domFileName.style.background = `linear-gradient(90deg, #000 ${data.ind/data.total * 100}%, #fff ${data.ind/data.total * 100 + 10}%)`
        this.domFileNameText.innerText = `${(data.ind/data.total * 100).toFixed(2)}%\n` + data.name
      },
      finishStoreFile({sign, data}) {
        this.files[sign].sort((a, b) => a.ind - b.ind)
        const url = this.files[sign].map(chunk => chunk.content).join('')
        const name = sign
        this.domSendBtn?.remove()
        if (!this.downLoadBtn) {
          this.downLoadBtn = document.createElement('button')
          this.downLoadBtn.innerText = '下载'
        }
        this.downLoadBtn.onclick = downloadFile.bind(this, {url, name})
        this.domContentWrap.appendChild(this.downLoadBtn)
        // downloadFile({url, name})
      },
      
    }

    Behavior.init()

    const sliceFile = (file, size = 1024*50) => {
      return new Promise((resolve) => {
        const reader = new FileReader()
        reader.readAsDataURL(file)
        reader.onload = (res) => {
          const dataUrl = res.target.result
          const id = Date.now()
          const chunks = [{
            id: id,
            type: 'file',
            name: file.name,
            totalSize: file.size,
            state: 'start'
          }]
          let ind = 0
          while(dataUrl.length > ind*size) {
            ind++
            chunks.push({
              id: id,
              type: 'file',
              name: file.name,
              totalSize: file.size,
              ind,
              state: 'msg',
              content: dataUrl.slice((ind - 1)*size, ind*size)
            })
          }
          chunks.push({
            id: id,
            type: 'file',
            name: file.name,
            totalSize: file.size,
            state: 'end'
          })
          chunks.splice(0, chunks.length, ...chunks.map(chunk => ({...chunk, total: ind})))
          resolve(chunks)
          // resolve(res.target.result)
        }
      })
    }

    const downloadFile = ({url, name}) => {
      const a = document.createElement('a')
      const objUrl = URL.createObjectURL(blobToFile(dataURLtoBlob(url), name))// 超大文件需要这个，不然很卡
      a.setAttribute('href', objUrl)
      a.setAttribute('download', 'cp_' + name)
      a.setAttribute('target', '_blank')
      a.click()
      a.remove()
      URL.revokeObjectURL(objUrl)
    }

    // 将base64转换为blob
    function dataURLtoBlob(dataurl) {
      let arr = dataurl.split(","),
        mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]),
        n = bstr.length,
        u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }
    // 将blob转换为file
    function blobToFile(theBlob, fileName) {
      theBlob.lastModifiedDate = new Date();
      theBlob.name = fileName;
      return theBlob;
    }



    class SSEHandler{
      constructor(url, cb) {
        this.SSE = new EventSource(url)
        this.SSE.onmessage = cb
        this.SSE.onerror = console.log
      }
      close() {
        this.SSE.close()
        this.SSE = null
      }
    }
  </script>
</body>
</html>